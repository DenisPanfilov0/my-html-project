<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Цветной Merge 15x15</title>
<style>
:root{ --cell:32px; --gap:3px; }
body{font-family:Inter, Roboto, Arial; background:#0f1724; color:#e6eef8; display:flex; align-items:flex-start; justify-content:center; padding:20px;}
.wrap{display:flex; gap:20px;}
.board { background:linear-gradient(180deg,#0b1220,#08101a); padding:14px; border-radius:12px; box-shadow:0 8px 30px rgba(2,6,23,.7);} 
.grid{ display:grid; grid-template-columns: repeat(15, calc(var(--cell))); grid-auto-rows: calc(var(--cell)); gap:var(--gap); background:rgba(255,255,255,0.03); padding:12px; border-radius:8px; }
.cell{ width:calc(var(--cell)); height:calc(var(--cell)); background:rgba(255,255,255,0.02); border-radius:6px; position:relative; overflow:hidden; }
.cell.highlight{ outline:2px solid rgba(255,255,255,0.06); }
.tile{ position:absolute; inset:4px; border-radius:6px; transition:transform .18s cubic-bezier(.2,.9,.25,1),opacity .18s; }
.ghost{ opacity:.45; transform:scale(.98); }
.particle { position:absolute; width:4px; height:4px; border-radius:50%; pointer-events:none; }
.ui{ width:320px; display:flex; flex-direction:column; gap:12px; }
.panel{ background:linear-gradient(180deg,#071326,#082034); padding:12px; border-radius:10px; box-shadow:0 6px 20px rgba(2,6,23,.6);} 
h1{font-size:18px; margin:0 0 6px 0}
.queue{ display:flex; gap:10px; justify-content:center; }
.piece-preview{ width:96px; height:96px; background:rgba(255,255,255,0.02); border-radius:8px; display:flex; align-items:center; justify-content:center; position:relative; cursor:pointer; }
.controls{ display:flex; gap:8px; align-items:center; }
button{ background:#17384d; color:#dff3ff; border:0; padding:8px 10px; border-radius:8px; cursor:pointer; }
.small{ padding:6px 8px; font-size:13px }
.meta{ display:flex; gap:8px; justify-content:space-between; align-items:center; }
.score{ font-size:16px; }
.color0{background:#e74c3c;} .color1{background:#3498db;} .color2{background:#2ecc71;} .color3{background:#f1c40f;}
.color4{background:#9b59b6;} .color5{background:#1abc9c;} .color6{background:#e67e22;} .color7{background:#95a5a6;}
.color-picker{ position:absolute; display:flex; gap:4px; background:rgba(0,0,0,.6); padding:4px; border-radius:6px; z-index:1000;}
.color-btn{ width:20px; height:20px; border-radius:4px; cursor:pointer; }
#bonus-container{ display:flex; justify-content:flex-end; margin-top:6px; }
#bonus-btn{ background:#2e7d32; color:#fff; }
</style>
</head>
<body>
<div class="wrap">
  <div class="board">
    <div class="grid" id="grid"></div>
  </div>
  <div class="ui">
    <div class="panel">
      <h1>Merge 15x15</h1>
      <div class="meta">
        <div class="score">Очки: <span id="score">0</span></div>
      </div>
    </div>
    <div class="panel">
      <div class="queue" id="queue"></div>
      <div class="controls">
        <button id="rotate" class="small">Повернуть (R)</button>
        <button id="restart" class="small">Перезапуск</button>
      </div>
      <div id="bonus-container">
        <button id="bonus-btn" class="small">Бонус: Изменить цвет</button>
      </div>
    </div>
  </div>
</div>

<script>
const ROWS=15, COLS=15;
const gridEl=document.getElementById('grid');
const queueEl=document.getElementById('queue');
const scoreEl=document.getElementById('score');
const rotateBtn=document.getElementById('rotate');
const restartBtn=document.getElementById('restart');
const bonusBtn=document.getElementById('bonus-btn');

let board=[];
let queue=[];
let activeIndex=0;
let currentRotation=0;
let score=0;
let bonusActive=false;

const COLORS=["color0","color1","color2","color3","color4","color5","color6","color7"];
const SHAPES=[
  [[0,0]], [[0,0],[1,0]], [[0,0],[0,1]], [[0,0],[1,0],[0,1],[1,1]],
  [[0,0],[1,0],[2,0]], [[0,0],[0,1],[0,2]], [[0,0],[1,0],[1,1]], [[0,0],[0,1],[1,1]],
  [[0,0],[1,0],[2,0],[2,1]], [[0,0],[1,0],[2,0],[1,1]]
];

function uid(){return Math.random().toString(36).slice(2,9);}
function rotateShape(shape){return shape.map(([x,y])=>[y,-x]);}
function normalize(shape){let minx=Math.min(...shape.map(s=>s[0])); let miny=Math.min(...shape.map(s=>s[1])); return shape.map(([x,y])=>[x-minx,y-miny]);}
function indexAt(r,c){if(r<0||c<0||r>=ROWS||c>=COLS) return -1; return r*COLS+c;}

function createGrid(){
  gridEl.innerHTML=''; board=[];
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const cell=document.createElement('div');
      cell.className='cell'; cell.dataset.r=r; cell.dataset.c=c;
      cell.addEventListener('click', ()=>onCellClick(r,c));
      cell.addEventListener('mouseenter', ()=>showGhost(r,c));
      cell.addEventListener('mouseleave', ()=>clearGhost());
      gridEl.appendChild(cell);
      board.push(null);
    }
  }
}

function generateColors(shape){
  let colors=[];
  for(let i=0;i<shape.length;i++){
    let attempts=0; let color;
    do{
      color=Math.floor(Math.random()*COLORS.length);
      attempts++;
    } while(i>=2 && color===colors[i-1] && color===colors[i-2] && attempts<20);
    colors.push(color);
  }
  return colors;
}

function randomPiece(){ const shape=normalize(SHAPES[Math.floor(Math.random()*SHAPES.length)].map(s=>[s[0],s[1]])); return {shape, colors:generateColors(shape), id:uid()};}
function refillQueue(){while(queue.length<3) queue.push(randomPiece()); renderQueue();}
function renderQueue(){
  queueEl.innerHTML='';
  queue.forEach((p,i)=>{
    const box=document.createElement('div');
    box.className='piece-preview';
    if(i===activeIndex) box.style.outline='2px solid #fff';
    const prev=renderPiecePreview(p,i===activeIndex);
    box.appendChild(prev);
    box.addEventListener('click',()=>{activeIndex=i; currentRotation=0; renderQueue();});
    box.addEventListener('contextmenu',(e)=>{e.preventDefault(); if(bonusActive) showColorPickerPreview(p, box);});
    queueEl.appendChild(box);
  });
}

function renderPiecePreview(piece,isActive){
  const wrap=document.createElement('div'); wrap.style.position='relative'; wrap.style.width='80px'; wrap.style.height='80px';
  const cellSize=20; let sh=normalize(piece.shape);
  if(isActive){ for(let i=0;i<currentRotation;i++){sh=rotateShape(sh); sh=normalize(sh);}}
  sh.forEach(([x,y],idx)=>{
    const t=document.createElement('div'); t.className='tile '+COLORS[piece.colors[idx]];
    t.style.width=(cellSize-6)+'px'; t.style.height=(cellSize-6)+'px';
    t.style.left=(x*cellSize+10)+'px'; t.style.top=(y*cellSize+10)+'px'; t.style.position='absolute';
    wrap.appendChild(t);
  });
  return wrap;
}

function renderBoard(){
  document.querySelectorAll('.cell').forEach((el,i)=>{
    el.querySelectorAll(':scope>.tile:not(.ghost)').forEach(n=>n.remove());
    const tile=board[i]; if(tile){ const t=document.createElement('div'); t.className='tile '+COLORS[tile.color]; el.appendChild(t);}
  });
}

function canPlace(shape,r0,c0){for(const [x,y] of shape){const r=r0+y,c=c0+x,idx=indexAt(r,c); if(idx<0||board[idx]) return false;} return true;}

function onCellClick(r,c){
  if(bonusActive) return; 
  const piece=queue[activeIndex]; if(!piece) return;
  let sh=piece.shape.map(s=>[s[0],s[1]]);
  for(let i=0;i<currentRotation;i++) sh=rotateShape(sh);
  sh=normalize(sh);
  if(!canPlace(sh,r,c)){flashCell(r,c); return;}
  sh.forEach(([x,y],idx)=>{const rr=r+y,cc=c+x,idxb=indexAt(rr,cc); board[idxb]={color:piece.colors[idx], id:piece.id};});
  queue.splice(activeIndex,1); refillQueue(); activeIndex=0; currentRotation=0; renderQueue(); renderBoard();
  spawnRandomCell(); // сразу кубик после установки
  checkBoardMerge(); // проверка всей доски на соединения
}

function flashCell(r,c){const idx=indexAt(r,c); if(idx<0) return; const cell=document.querySelectorAll('.cell')[idx]; cell.classList.add('highlight'); setTimeout(()=>cell.classList.remove('highlight'),300);}

function spawnRandomCell(){
  let attempts=0;
  while(attempts<50){
    const r=Math.floor(Math.random()*ROWS);
    const c=Math.floor(Math.random()*COLS);
    const idx=indexAt(r,c);
    if(!board[idx]){
      board[idx]={color:Math.floor(Math.random()*COLORS.length), id:uid()}; renderBoard(); break;
    }
    attempts++;
  }
}

function checkBoardMerge(){
  const visited=Array(ROWS).fill(0).map(()=>Array(COLS).fill(false));
  let hasMerge=false;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(!visited[r][c] && board[indexAt(r,c)]){
        const color=board[indexAt(r,c)].color;
        const cluster=[];
        const stack=[[r,c]];
        while(stack.length>0){
          const [rr,cc]=stack.pop();
          if(rr<0||cc<0||rr>=ROWS||cc>=COLS) continue;
          if(visited[rr][cc]) continue;
          const t=board[indexAt(rr,cc)];
          if(!t || t.color!==color) continue;
          visited[rr][cc]=true;
          cluster.push([rr,cc]);
          stack.push([rr+1,cc],[rr-1,cc],[rr,cc+1],[rr,cc-1]);
        }
        if(cluster.length>=3){hasMerge=true; cluster.forEach(([rr,cc])=>{board[indexAt(rr,cc)]=null; spawnParticles(rr,cc,COLORS[color]); score++;});}
      }
    }
  }
  if(hasMerge){renderBoard(); scoreEl.textContent=score; setTimeout(checkBoardMerge, 150);}
}

function spawnParticles(r,c,colorClass){ 
  const cell=document.querySelectorAll('.cell')[indexAt(r,c)];
  for(let i=0;i<6;i++){
    const p=document.createElement('div'); p.className='particle '+colorClass;
    p.style.background=window.getComputedStyle(document.querySelector('.'+colorClass)).backgroundColor;
    p.style.left='12px'; p.style.top='12px'; cell.appendChild(p);
    const angle=Math.random()*2*Math.PI; const dist=10+Math.random()*10;
    p.style.transform=`translate(${Math.cos(angle)*dist}px,${Math.sin(angle)*dist}px)`; p.style.opacity=1;
    setTimeout(()=>{p.style.opacity=0; p.remove();},400);
  }
}

function showGhost(r,c){ clearGhost(); const piece=queue[activeIndex]; if(!piece) return;
  let sh=piece.shape.map(s=>[s[0],s[1]]); for(let i=0;i<currentRotation;i++) sh=rotateShape(sh); sh=normalize(sh);
  if(!canPlace(sh,r,c)) return; const cells=document.querySelectorAll('.cell');
  sh.forEach(([x,y],idx)=>{const idxb=indexAt(r+y,c+x); if(idxb>=0){const ghost=document.createElement('div'); ghost.className='tile '+COLORS[piece.colors[idx]]+' ghost'; cells[idxb].appendChild(ghost);}});
}
function clearGhost(){document.querySelectorAll('.cell').forEach(c=>c.querySelectorAll('.ghost').forEach(g=>g.remove()));}

rotateBtn.addEventListener('click',()=>{currentRotation=(currentRotation+1)%4; renderQueue();});
window.addEventListener('keydown', e=>{if(e.key==='r'||e.key==='R'){currentRotation=(currentRotation+1)%4; renderQueue();}});
restartBtn.addEventListener('click',()=>init());
bonusBtn.addEventListener('click',()=>{bonusActive=!bonusActive; bonusBtn.style.background=bonusActive?'#388e3c':'#2e7d32';});

function showColorPickerPreview(piece, container){
  const existing=document.querySelector('.color-picker'); if(existing) existing.remove();
  const picker=document.createElement('div'); picker.className='color-picker';
  COLORS.forEach((color,i)=>{
    const btn=document.createElement('div'); btn.className='color-btn '+color;
    btn.style.background=window.getComputedStyle(document.querySelector('.'+color)).backgroundColor;
    btn.addEventListener('click',()=>{piece.colors=piece.colors.map(_=>i); renderQueue(); picker.remove();});
    picker.appendChild(btn);
  });
  document.body.appendChild(picker);
  const rect=container.getBoundingClientRect();
  picker.style.left=rect.left+'px'; picker.style.top=(rect.bottom+4)+'px';
  const hidePicker=(e)=>{if(!picker.contains(e.target)){picker.remove(); document.removeEventListener('click',hidePicker);}};
  setTimeout(()=>document.addEventListener('click',hidePicker),10);
}

function init(){
  createGrid(); score=0; scoreEl.textContent=score; queue=[]; refillQueue(); renderBoard();
  const count=10+Math.floor(Math.random()*11);
  for(let k=0;k<count;k++){ const r=Math.floor(Math.random()*ROWS); const c=Math.floor(Math.random()*COLS);
    const idx=indexAt(r,c); if(!board[idx]) board[idx]={color:Math.floor(Math.random()*COLORS.length), id:uid()};}
  renderBoard();
}

init();
</script>
</body>
</html>
